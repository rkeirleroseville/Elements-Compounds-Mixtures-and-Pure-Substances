<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Particle Diagram Quiz — SpeedRun + Google Sheets Leaderboard</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a36; --ink:#e8ecf8; --muted:#9aa6d1; --accent:#63b3ff;
      --ok:#58e06c; --bad:#ff6b6b; --btn:#0b1430; --btn-border:#2c3f86; --btn-hover:#3a56b1;
      --btn-correct:#124d24; --btn-incorrect:#5a1c1c; --btn-correct-border:#2f8f46; --btn-incorrect-border:#9e2a2a; --chip:#17224a;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 20% -10%, #18275c 0%, transparent 60%),radial-gradient(900px 500px at 110% 10%, #1a2858 0%, transparent 65%),var(--bg);color:var(--ink);display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:14px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .panel{background:linear-gradient(180deg,#0f1733 0%,#0d1634 100%);border:1px solid #22306a;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls{display:grid;gap:10px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{cursor:pointer;background:var(--btn);border:1px solid var(--btn-border);color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;transition:.15s}
    button:hover{border-color:var(--btn-hover)} .btn-accent{background:linear-gradient(90deg,#1c6fe8,#20a5e8);border:0}
    .btn-ghost{background:transparent;border-color:#2a3b80}
    .answer-btn{min-width:220px}
    .answer-btn.correct{background:var(--btn-correct);border-color:var(--btn-correct-border)}
    .answer-btn.incorrect{background:var(--btn-incorrect);border-color:var(--btn-incorrect-border)}
    .answer-btn:disabled{opacity:.9}
    .status{min-height:24px;font-size:14px;color:var(--muted)} .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #2a3b80;color:#cfe0ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .stage{display:grid;grid-template-columns:1fr 300px;gap:12px}
    .canvas-wrap{position:relative}
    canvas{width:100%;height:100%;display:block;border-radius:16px;background:#0a0f22;border:1px solid #1a254d}
    .footer{font-size:12px;color:var(--muted)}
    .board{display:grid;gap:8px} .board h2{margin:0 0 6px;font-size:14px;color:#cfe0ff}
    .entry{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #2a3b80;background:#0e1531;border-radius:10px}
    .entry.me{border-color:#3f60de;box-shadow:0 0 0 1px #3f60de66 inset}
    .name{font-weight:700} .best{font-variant-numeric:tabular-nums}
    .nick{display:flex;gap:8px;align-items:center} .nick input{background:#0b1430;border:1px solid #2c3f86;color:#e8ecf8;padding:8px 10px;border-radius:10px;outline:none;min-width:160px}
  </style>
</head>
<body>
  <header>
    <h1>Particle Diagram Quiz</h1>
    <div class="chips">
      <span class="chip" id="scoreChip">Score: 0</span>
      <span class="chip" id="streakChip">Streak: 0</span>
      <span class="chip" id="modeChip">Mode: Free Play</span>
      <span class="chip" id="timerChip" style="display:none">Time: 60s</span>
      <span class="chip" id="runBestChip" style="display:none">Run Best: 0</span>
      <span class="chip" id="playerChip">Player: Guest</span>
    </div>
  </header>

  <section class="panel controls">
    <div class="row">
      <button id="btnGenerate" class="btn-accent">Generate</button>
      <button id="btnStartRun" class="btn-ghost">Start 60s SpeedRun</button>
      <button id="btnEndRun" class="btn-ghost" style="display:none">End Run</button>
      <div class="nick">
        <label class="chip" style="border:none;background:#17224a" for="nick">Nickname</label>
        <input id="nick" type="text" placeholder="Enter nickname" maxlength="24" />
        <button id="setNick">Set</button>
      </div>
      <div id="answerHost" class="row" style="flex:1 1 auto"></div>
    </div>
    <div id="status" class="status">Press <strong>Generate</strong> to create a diagram.</div>
  </section>

  <section class="stage">
    <div class="panel canvas-wrap">
      <canvas id="scene" width="1200" height="800" aria-label="Particle diagram canvas"></canvas>
    </div>
    <aside class="panel">
      <div class="board">
        <h2>SpeedRun Leaderboard (best 60s streak)</h2>
        <div id="boardList"></div>
      </div>
    </aside>
  </section>

  <div class="footer">Elemental molecule = two identical touching circles; compound = 2+ touching circles with ≥1 different colour. Same colour ⇒ same size within an image. Compounds use a consistent prototype & shape (linear/V) within each image; in “Mixture of compounds”, two distinct, internally consistent types may appear. Global spacing prevents unbonded atoms from appearing bonded.</div>

  <script>
    // =============== CONFIG (set this once) =================
    // Paste your Google Apps Script Web App URL (ends with /exec)
    const REST_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzJ1bV2N7fWknCWHXaAOQgX6RuVhy9Q2yLyU6E-4Qb2wLNVrBGjjmJgSmFjQrpTd2gg/exec';

    // =============== Quiz internals =========================
    const HIDDEN_COUNT=15, LOOSE_PACKING_PAD=28, GLOBAL_GAP_FACTOR=0.35;
    const CATEGORIES=[
      'Mixture of different elements','Mixture of an element and a compound','Mixture of compounds','Pure substance of an element','Pure substance of a compound'
    ];
    const STEP1=['Mixture','Pure substance'];
    const STEP2_MAP={ 'Mixture':['Mixture of different elements','Mixture of an element and a compound','Mixture of compounds'], 'Pure substance':['Pure substance of an element','Pure substance of a compound'] };

    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    const rnd={ _rng:mulberry32(Math.floor(Math.random()*1e9)), next(){return this._rng();}, range(a,b){return a+(b-a)*this.next();}, int(a,b){return Math.floor(this.range(a,b+1));}, pick(arr){return arr[this.int(0,arr.length-1)]}, shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=this.int(0,i);[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;} };

    const canvas=document.getElementById('scene'); const ctx=canvas.getContext('2d');
    function resizeCanvas(){const wrap=canvas.parentElement.getBoundingClientRect();const m=16;canvas.width=Math.max(600,Math.floor(wrap.width)-m*2);canvas.height=Math.max(380,Math.floor(wrap.height)-m*2);} window.addEventListener('resize',()=>{resizeCanvas();});
    let placed=[]; let imageAnswer=null;

    const palette=['#ff6b6b','#6bc8ff','#7cff6b','#ffd56b','#c86bff','#6bffc8','#ff9df2','#a9ff6b','#ffb36b','#6b9bff','#9fffd0','#e0ff6b'];
    function makeColourSizes(meanR){const map=new Map();return function getSize(color){if(!map.has(color)){map.set(color,Math.max(4,meanR*(0.85+rnd.range(0,0.3))))}return map.get(color);}}

    function circlesTooClose(a,b){const dx=a.x-b.x,dy=a.y-b.y;const rr=(a.r+b.r)*(1+GLOBAL_GAP_FACTOR);return dx*dx+dy*dy<rr*rr-1e-3}
    function inBounds(x,y,r,w,h){return x-r>=4&&y-r>=4&&x+r<=w-4&&y+r<=h-4}
    function drawCircle(c){const {x,y,r,color}=c;const g=ctx.createRadialGradient(x-r*0.4,y-r*0.6,r*0.2,x,y,r);g.addColorStop(0,'#ffffff');g.addColorStop(0.05,color);g.addColorStop(1,color);ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1;ctx.stroke();}
    function tryPlace(atoms,tries=600){const W=canvas.width,H=canvas.height,pad=LOOSE_PACKING_PAD;while(tries-->0){const ax=rnd.range(pad,W-pad),ay=rnd.range(pad,H-pad);const th=rnd.range(0,Math.PI*2),c=Math.cos(th),s=Math.sin(th);let ok=true;const abs=[];for(const a of atoms){const x=ax+(a.rel.x*c-a.rel.y*s),y=ay+(a.rel.x*s+a.rel.y*c);if(!inBounds(x,y,a.r,W,H)){ok=false;break;}for(const p of placed){if(circlesTooClose({x,y,r:a.r},{x:p.x,y:p.y,r:p.r})){ok=false;break;}}if(!ok)break;abs.push({x,y,r:a.r,color:a.color});}if(ok){abs.forEach(c=>{placed.push(c);drawCircle(c);});return true;}}return false}

    function atom(r,color){return {r,color,rel:{x:0,y:0}}}
    function buildMonatomic(meanR,getSize,color){return [atom(getSize(color),color)]}
    function buildDiatomic(meanR,getSize,color){const r=getSize(color);const a=atom(r,color),b=atom(r,color);b.rel={x:r+r,y:0};return [a,b]}
    function buildCompound(proto,meanR,getSize,A,B,shape){const mode=shape?.mode||'linear';const ANG=shape?.angle??Math.PI/12;if(proto==='AB'){const ra=getSize(A),rb=getSize(B);const a=atom(ra,A),b=atom(rb,B);b.rel={x:ra+rb,y:0};return [a,b];}if(proto==='AB2'){const ra=getSize(A),rb=getSize(B);const aC=atom(ra,A);const d=ra+rb;let b1,b2;if(mode==='linear'){b1=atom(rb,B);b1.rel={x:d,y:0};b2=atom(rb,B);b2.rel={x:-d,y:0};}else{const c=Math.cos(ANG),s=Math.sin(ANG);b1=atom(rb,B);b1.rel={x:d*c,y:d*s};b2=atom(rb,B);b2.rel={x:d*c,y:-d*s};}return [aC,b1,b2];}const ra=getSize(A),rb=getSize(B);const bC=atom(rb,B);const d=ra+rb;let a1,a2;if(mode==='linear'){a1=atom(ra,A);a1.rel={x:d,y:0};a2=atom(ra,A);a2.rel={x:-d,y:0};}else{const c=Math.cos(ANG),s=Math.sin(ANG);a1=atom(ra,A);a1.rel={x:d*c,y:d*s};a2=atom(ra,A);a2.rel={x:d*c,y:-d*s};}return [bC,a1,a2]}

    function generateScene(){resizeCanvas();ctx.clearRect(0,0,canvas.width,canvas.height);placed.length=0;const meanR=14;const colours=rnd.shuffle(palette.slice());const getSize=makeColourSizes(meanR);const category=rnd.pick(CATEGORIES);function placeMany(b,n){for(let i=0;i<n;i++){tryPlace(b());}}let remaining=HIDDEN_COUNT;if(category==='Mixture of different elements'){const nTypes=rnd.pick([2,3]);const split=Array(nTypes).fill(0).map(()=>1);for(let i=0;i<remaining-nTypes;i++){split[rnd.int(0,nTypes-1)]++;}for(let t=0;t<nTypes;t++){const color=colours[t];const di=rnd.next()<0.5;placeMany(()=>di?buildDiatomic(meanR,getSize,color):buildMonatomic(meanR,getSize,color),split[t]);}}else if(category==='Mixture of an element and a compound'){const colorE=colours[0];const [A,B]=[colours[1],colours[2]];const proto=rnd.pick(['AB','AB2','A2B']);const shape={mode:(rnd.next()<0.5?'linear':'v'),angle:rnd.range(Math.PI/16,Math.PI/6)};const nC=Math.floor(remaining*0.5);const nE=remaining-nC;const elDi=rnd.next()<0.5;placeMany(()=>elDi?buildDiatomic(meanR,getSize,colorE):buildMonatomic(meanR,getSize,colorE),nE);placeMany(()=>buildCompound(proto,meanR,getSize,A,B,shape),nC);}else if(category==='Mixture of compounds'){const [A,B,C,D]=colours.slice(0,4);let p1=rnd.pick(['AB','AB2','A2B']);let p2=rnd.pick(['AB','AB2','A2B']);if(p2===p1){p2=rnd.pick(['AB','AB2','A2B'].filter(p=>p!==p1));}const s1={mode:(rnd.next()<0.5?'linear':'v'),angle:rnd.range(Math.PI/16,Math.PI/6)};const s2={mode:(rnd.next()<0.5?'linear':'v'),angle:rnd.range(Math.PI/16,Math.PI/6)};const n1=Math.floor(remaining/2),n2=remaining-n1;placeMany(()=>buildCompound(p1,meanR,getSize,A,B,s1),n1);placeMany(()=>buildCompound(p2,meanR,getSize,C,D,s2),n2);}else if(category==='Pure substance of an element'){const color=colours[0];const di=rnd.next()<0.5;placeMany(()=>di?buildDiatomic(meanR,getSize,color):buildMonatomic(meanR,getSize,color),remaining);}else{const [A,B]=[colours[0],colours[1]];const proto=rnd.pick(['AB','AB2','A2B']);const shape={mode:(rnd.next()<0.5?'linear':'v'),angle:rnd.range(Math.PI/16,Math.PI/6)};placeMany(()=>buildCompound(proto,meanR,getSize,A,B,shape),remaining);}imageAnswer=category}

    let score=0, streak=0, step1WasCorrect=null; let runActive=false, runSeconds=60, runRemaining=60, runBest=0, runTimer=null;

    const statusEl=document.getElementById('status'); const answerHost=document.getElementById('answerHost'); const scoreChip=document.getElementById('scoreChip'); const streakChip=document.getElementById('streakChip'); const modeChip=document.getElementById('modeChip'); const timerChip=document.getElementById('timerChip'); const runBestChip=document.getElementById('runBestChip'); const playerChip=document.getElementById('playerChip');
    function setStatus(msg,cls){statusEl.className='status'+(cls?(' '+cls):'');statusEl.innerHTML=msg}
    function refreshScore(){scoreChip.textContent=`Score: ${score}`;streakChip.textContent=`Streak: ${streak}`}
    function clearAnswers(){answerHost.querySelectorAll('button').forEach(b=>{b.classList.remove('correct','incorrect');b.disabled=false;})}
    function correctStep1For(cat){return cat.startsWith('Mixture')?'Mixture':'Pure substance'}

    function ringBell(){try{const a=new (window.AudioContext||window.webkitAudioContext)();const o1=a.createOscillator(),o2=a.createOscillator();const mix=a.createGain();mix.gain.value=.15;const env=a.createGain();env.gain.value=0;o1.type='sine';o1.frequency.value=1240;o2.type='sine';o2.frequency.value=1860;o1.connect(mix);o2.connect(mix);mix.connect(env);env.connect(a.destination);const t=a.currentTime;env.gain.setValueAtTime(0,t);env.gain.linearRampToValueAtTime(.6,t+.01);env.gain.exponentialRampToValueAtTime(.0001,t+.35);o1.start(t);o2.start(t);o1.stop(t+.4);o2.stop(t+.4);setTimeout(()=>a.close(),500)}catch(e){}}
    function toast(msg,sound=false,duration=1200){const t=document.createElement('div');t.textContent=msg;t.style.position='fixed';t.style.left='50%';t.style.bottom='24px';t.style.transform='translateX(-50%)';t.style.padding='10px 14px';t.style.background='rgba(20,30,70,.95)';t.style.border='1px solid #3f60de';t.style.borderRadius='10px';t.style.color='#e8ecf8';t.style.zIndex=9999;document.body.appendChild(t);if(sound)ringBell();setTimeout(()=>{t.style.transition='opacity .4s ease';t.style.opacity='0';setTimeout(()=>t.remove(),400)},duration)}
    function toastHTML(html,sound=false,duration=1200){const t=document.createElement('div');t.innerHTML=html;t.style.position='fixed';t.style.left='50%';t.style.bottom='24px';t.style.transform='translateX(-50%)';t.style.padding='12px 16px';t.style.background='rgba(20,30,70,.95)';t.style.border='1px solid #3f60de';t.style.borderRadius='10px';t.style.color='#e8ecf8';t.style.zIndex=9999;t.style.maxWidth='90%';t.querySelectorAll('a').forEach(a=>{a.style.color='#a6d1ff';a.style.textDecoration='underline';a.target='_blank';a.rel='noopener noreferrer'});document.body.appendChild(t);if(sound)ringBell();setTimeout(()=>{t.style.transition='opacity .4s ease';t.style.opacity='0';setTimeout(()=>t.remove(),400)},duration);return t}
    function bigPop(msg){const overlay=document.createElement('div');overlay.style.position='fixed';overlay.style.inset='0';overlay.style.background='rgba(5,10,25,.75)';overlay.style.display='grid';overlay.style.placeItems='center';overlay.style.zIndex=10000;const box=document.createElement('div');box.style.background='#0f1733';box.style.border='1px solid #3f60de';box.style.borderRadius='16px';box.style.padding='28px 32px';box.style.color='#e8ecf8';box.style.textAlign='center';box.style.maxWidth='720px';box.style.margin='0 12px';const h=document.createElement('div');h.textContent=msg;h.style.fontSize='26px';h.style.fontWeight='800';h.style.letterSpacing='.3px';box.appendChild(h);const btn=document.createElement('button');btn.textContent='Close';btn.style.marginTop='16px';btn.style.padding='10px 14px';btn.style.background='#0b1430';btn.style.border='1px solid #3f60de';btn.style.borderRadius='10px';btn.style.color='#e8ecf8';btn.addEventListener('click',()=>overlay.remove());box.appendChild(btn);overlay.appendChild(box);document.body.appendChild(overlay);ringBell()}

    // SpeedRun helpers
    function refreshRunChips(){timerChip.style.display=runActive?'inline-flex':'none';runBestChip.style.display=runActive?'inline-flex':'none';timerChip.textContent=`Time: ${runRemaining}s`;runBestChip.textContent=`Run Best: ${runBest}`}
    function startRun(){const name=getPlayer();if(!name||name==='Guest'){toast('Set your nickname first!',true,1400);return;}runActive=true;runRemaining=runSeconds;runBest=0;streak=0;score=0;refreshScore();step1WasCorrect=null;modeChip.textContent='Mode: SpeedRun';document.getElementById('btnStartRun').style.display='none';document.getElementById('btnEndRun').style.display='inline-flex';refreshRunChips();setStatus('SpeedRun started — best streak in 60s wins!', 'ok');generateScene();renderAnswers();if(runTimer)clearInterval(runTimer);runTimer=setInterval(()=>{runRemaining-=1;if(runRemaining<=0){endRun();}else{refreshRunChips();}},1000)}
    async function endRun(){if(!runActive)return;runActive=false;if(runTimer){clearInterval(runTimer);runTimer=null;}document.getElementById('btnStartRun').style.display='inline-flex';document.getElementById('btnEndRun').style.display='none';modeChip.textContent='Mode: Free Play';refreshRunChips();setStatus(`⏱️ Time! Your best streak this run: <strong>${runBest}</strong>`, '');await LB.submit(getPlayer(),runBest);await renderBoard()}

    // Leaderboard backend (Google Sheets via Apps Script)
    const LS_PLAYER='pdq.player';
    function getPlayer(){return localStorage.getItem(LS_PLAYER)||'Guest'}
    function setPlayer(name){localStorage.setItem(LS_PLAYER,name);playerChip.textContent=`Player: ${name}`}

    const LB={
      async top5(){
        if(!REST_ENDPOINT){ return []; }
        try{ const r=await fetch(REST_ENDPOINT+"?fn=top5"); return await r.json(); }
        catch(e){ console.warn('top5 failed', e); return []; }
      },
      async submit(name,score){
        if(!REST_ENDPOINT) return {ok:false};
        try{ await fetch(REST_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({fn:'submit', name, score}) }); }
        catch(e){ console.warn('submit failed', e); }
        return {ok:true};
      }
    };

    async function renderBoard(){
      const list=document.getElementById('boardList');
      const items=await LB.top5();
      if(!items||items.length===0){ list.innerHTML='<div class="status">Leaderboard empty (set up Google Sheet and paste the URL at the top).</div>'; return; }
      const me=getPlayer(); list.innerHTML='';
      items.forEach((it,i)=>{ const row=document.createElement('div'); row.className='entry'+(it.name===me?' me':''); const left=document.createElement('div'); left.className='name'; left.textContent=`${i+1}. ${it.name}`; const right=document.createElement('div'); right.className='best'; right.textContent=it.best; row.appendChild(left); row.appendChild(right); list.appendChild(row); });
    }

    function renderTwoStep(){
      answerHost.innerHTML='';
      const step1Wrap=document.createElement('div'); step1Wrap.className='row';
      const s1Btns=STEP1.map(lbl=>{const b=document.createElement('button'); b.textContent=lbl; b.className='answer-btn'; return b;}); s1Btns.forEach(b=>step1Wrap.appendChild(b)); answerHost.appendChild(step1Wrap);
      const step2Wrap=document.createElement('div'); step2Wrap.className='row'; step2Wrap.style.opacity=.5; step2Wrap.style.pointerEvents='none'; answerHost.appendChild(step2Wrap);
      function enableStep2(forLabel){ step2Wrap.innerHTML=''; step2Wrap.style.opacity=1; step2Wrap.style.pointerEvents='auto'; const labels=STEP2_MAP[forLabel]; const step2Buttons=labels.map(lbl=>{const b=document.createElement('button'); b.textContent=lbl; b.className='answer-btn'; step2Wrap.appendChild(b); return b;}); step2Buttons.forEach(btn=>{ btn.addEventListener('click',()=>{ step2Buttons.forEach(b=>b.disabled=true); const correct=(btn.textContent===imageAnswer); if(correct){ btn.classList.add('correct'); score+=1; if(step1WasCorrect===true){ streak+=1; if(runActive){ runBest=Math.max(runBest,streak); refreshRunChips(); } if(streak===5) toast('Now go for 10 in a row!',true,1500); if(streak===10) toast('Oh yeh!',true,1600); if(streak===50){ const t=toastHTML("Congratulations, you're a master. <a href='https://www.youtube.com/watch?v=Aq5WXmQQooo&list=RDAq5WXmQQooo&start_radio=1'>Click Here to receive your prize</a>",true,5000); const a=t.querySelector('a'); if(a){ a.addEventListener('click',()=>{ setTimeout(()=>toast('Ok, now go for a 100!',true,1600),300); }); } } if(streak===100){ bigPop("It's all about the journey, not the destination. You made it!"); } } setStatus('✅ Correct!','ok'); } else { btn.classList.add('incorrect'); step2Buttons.forEach(b=>{ if(b.textContent===imageAnswer){ b.classList.add('correct'); }}); setStatus('❌ Not quite.','bad'); streak=0; } refreshScore(); }); }); }
      s1Btns.forEach(btn=>{ btn.addEventListener('click',()=>{ s1Btns.forEach(b=>b.disabled=true); const correctLabel=correctStep1For(imageAnswer); if(btn.textContent===correctLabel){ btn.classList.add('correct'); step1WasCorrect=true; setStatus('✅ Step 1 correct. Now choose the specific type.','ok'); enableStep2(correctLabel); } else { btn.classList.add('incorrect'); step1WasCorrect=false; s1Btns.forEach(b=>{ if(b.textContent===correctLabel){ b.classList.add('correct'); }}); setStatus('❌ Step 1 not quite. Now choose the specific type.','bad'); streak=0; refreshScore(); enableStep2(correctLabel); } }); });
    }

    function renderAnswers(){ renderTwoStep(); }

    document.getElementById('btnGenerate').addEventListener('click',()=>{ setStatus('A new diagram was generated. Classify it!',''); step1WasCorrect=null; clearAnswers(); generateScene(); renderAnswers(); })
    document.getElementById('btnStartRun').addEventListener('click', startRun);
    document.getElementById('btnEndRun').addEventListener('click', endRun);

    const nickInput=document.getElementById('nick'); const setNickBtn=document.getElementById('setNick');
    function applyNick(){ const raw=(nickInput.value||'').trim().slice(0,24); const name=raw||'Guest'; setPlayer(name); toast(`Player set to ${name}`,false,900); renderBoard(); }
    setNickBtn.addEventListener('click',applyNick); nickInput.addEventListener('keydown',e=>{ if(e.key==='Enter') applyNick(); })

    // Init
    nickInput.value=getPlayer(); playerChip.textContent=`Player: ${getPlayer()}`; resizeCanvas(); renderAnswers(); refreshScore(); renderBoard();
  </script>

  <!-- ===================== GOOGLE SHEETS BACKEND (step-by-step) =====================
  1) Create a Google Sheet called "PDQ Leaderboard". In row 1 put headers exactly:
       Name | Best

  2) Extensions → Apps Script. Delete any code and paste the code below. Save.

  function doGet(e) {
    const sheet = SpreadsheetApp.getActive().getSheetByName('Sheet1');
    const values = sheet.getRange(2,1,Math.max(0,sheet.getLastRow()-1),2).getValues();
    const entries = values.filter(r => r[0]).map(r => ({ name: String(r[0]), best: Number(r[1])||0 }));
    entries.sort((a,b)=> b.best - a.best || a.name.localeCompare(b.name));
    return ContentService.createTextOutput(JSON.stringify(entries.slice(0,5)))
      .setMimeType(ContentService.MimeType.JSON);
  }

  function doPost(e) {
    const body = JSON.parse(e.postData.contents || '{}');
    if (body.fn === 'submit') {
      const name = String(body.name||'').slice(0,24);
      const score = Number(body.score||0);
      const sheet = SpreadsheetApp.getActive().getSheetByName('Sheet1');
      const data = sheet.getDataRange().getValues();
      let found = false;
      for (let i=1;i<data.length;i++) {
        if (String(data[i][0]) === name) {
          const current = Number(data[i][1])||0;
          if (score > current) sheet.getRange(i+1,2).setValue(score);
          found = true; break;
        }
      }
      if (!found) sheet.appendRow([name, score]);
      return ContentService.createTextOutput(JSON.stringify({ ok:true }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ ok:false }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  3) Deploy → New deployment → Type: Web app
     - Execute as: Me
     - Who has access: Anyone
     - Click Deploy → Authorize → Allow. Copy the URL (ends with /exec)

  4) Back in this HTML (near the top), paste the URL into:
       const REST_ENDPOINT = 'https://script.google.com/macros/s/XXXXXXXXXXXX/exec';

  5) Upload this single HTML file to GitHub Pages / LMS and share the link. Done.

  Notes:
  • The leaderboard stores only the best SpeedRun streak per nickname. Students need to click Start 60s SpeedRun and have a nickname set.
  • To reset the board, clear rows under the header in your Sheet.
  • You can rename the Sheet tab if you also change 'Sheet1' in the script.
  ================================================================================ -->
</body>
</html>
